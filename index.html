<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi2 Sentinel | v8.2 Nano</title>
    
    <!-- FONTS & LIBS -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pi: {
                            bg: '#020204',
                            card: '#0e0e14',
                            primary: '#00f2ea', // Cyan Neon
                            success: '#00ff9d',
                            danger: '#ff2a55',
                            dim: '#555a6d'
                        }
                    },
                    fontFamily: { mono: ['"JetBrains Mono"', 'monospace'], sans: ['"Inter"', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020204; overflow-x: hidden; color: #eee; }
        .glass { background: rgba(14, 14, 20, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        .glow-text { text-shadow: 0 0 10px rgba(0, 242, 234, 0.5); }
        .scanline { position: absolute; top:0; left:0; width:100%; height:2px; background: rgba(0,242,234,0.3); opacity:0.5; animation: scan 3s infinite linear; pointer-events:none; }
        @keyframes scan { 0% {top:0;} 100% {top:100%;} }
    </style>
</head>
<body class="font-sans antialiased relative selection:bg-pi-primary selection:text-black">

    <div class="max-w-7xl mx-auto px-4 py-8 min-h-screen flex flex-col">
        <!-- HEADER -->
        <header class="flex justify-between items-center mb-8 glass p-5 rounded-xl border-l-4 border-pi-primary">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-black rounded flex items-center justify-center text-xl font-bold border border-white/10">œÄ¬≤</div>
                <div>
                    <h1 class="text-xl font-black text-white tracking-widest">SENTINEL <span class="text-xs bg-pi-primary/10 text-pi-primary px-2 py-0.5 rounded border border-pi-primary/20">v8.2 STABLE</span></h1>
                    <p class="text-[10px] text-pi-dim uppercase tracking-wider">Devnet Diagnostics Tool</p>
                </div>
            </div>
            <div class="flex gap-2">
                <a href="https://docs.pi2.network" target="_blank" class="text-[10px] bg-white/5 border border-white/10 px-3 py-2 rounded hover:bg-white/10 transition uppercase font-bold text-gray-400">
                    <i class="fas fa-faucet mr-1"></i> Faucet Info
                </a>
                <button onclick="downloadCSV()" id="btn_export" class="hidden text-[10px] bg-pi-success/10 border border-pi-success/30 px-3 py-2 rounded text-pi-success transition uppercase font-bold">
                    <i class="fas fa-file-csv mr-1"></i> Export Data
                </button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-grow">
            <!-- SETUP SIDEBAR -->
            <aside class="lg:col-span-4 flex flex-col gap-6">
                <div class="glass p-6 rounded-xl relative overflow-hidden">
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i class="fas fa-wallet text-pi-primary"></i> Wallet Config
                    </h2>
                    
                    <div id="setupForm" class="space-y-4 relative z-10">
                        <div class="bg-red-900/10 border border-red-900/30 p-3 rounded text-[10px] text-red-300 leading-relaxed">
                            ‚ö†Ô∏è <b>Burner Wallet Only!</b> Never use keys that hold real funds. Use keys generated for Testnet.
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] text-gray-500 uppercase font-bold">Address</label>
                            <input type="text" id="inp_addr" class="w-full bg-black/40 border border-white/10 rounded p-2.5 text-xs font-mono text-pi-primary focus:border-pi-primary focus:outline-none transition" placeholder="set1...">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] text-gray-500 uppercase font-bold">Private Key</label>
                            <input type="password" id="inp_pk" class="w-full bg-black/40 border border-white/10 rounded p-2.5 text-xs font-mono text-pi-primary focus:border-pi-primary focus:outline-none transition" placeholder="0x...">
                        </div>
                        <button onclick="saveConfig()" class="w-full bg-pi-primary hover:bg-cyan-300 text-black font-bold py-3 rounded text-xs uppercase tracking-widest transition shadow-[0_0_15px_rgba(0,242,234,0.3)]">Connect Wallet</button>
                    </div>

                    <div id="connectedView" class="hidden text-center py-6">
                        <div class="w-16 h-16 mx-auto bg-pi-success/10 rounded-full flex items-center justify-center mb-3">
                            <i class="fas fa-check text-2xl text-pi-success"></i>
                        </div>
                        <div class="text-[10px] text-gray-500 uppercase mb-1">Active Target</div>
                        <div class="bg-black/30 text-pi-success font-mono text-[10px] p-2 rounded mb-4 break-all border border-pi-success/20" id="display_addr">...</div>
                        <button onclick="disconnect()" class="text-xs text-red-400 hover:text-white border-b border-red-900 pb-0.5 transition">Disconnect</button>
                    </div>
                </div>

                <!-- EDUCATION -->
                <div class="glass p-6 rounded-xl flex-grow flex flex-col justify-between border-t border-pi-primary/30">
                    <div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                             <i class="fas fa-lightbulb text-yellow-400"></i> AI Analysis
                        </h3>
                        <div id="insight_box" class="text-center p-5 bg-black/20 rounded border border-white/5 text-xs text-gray-400 italic">
                            System idle. Start benchmark to analyze FastSet performance.
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-4 text-[10px] text-gray-500">
                        <div class="flex items-center gap-1.5"><div class="w-1.5 h-1.5 bg-pi-primary rounded-full"></div> &lt;800ms (Fast)</div>
                        <div class="flex items-center gap-1.5"><div class="w-1.5 h-1.5 bg-yellow-500 rounded-full"></div> Normal Load</div>
                        <div class="flex items-center gap-1.5"><div class="w-1.5 h-1.5 bg-red-500 rounded-full"></div> Proxy Throttle</div>
                    </div>
                </div>
            </aside>

            <!-- DASHBOARD -->
            <section class="lg:col-span-8 flex flex-col gap-6">
                <!-- METRICS -->
                <div class="grid grid-cols-4 gap-4">
                    <div class="glass p-4 rounded text-center">
                        <div class="text-[10px] text-gray-500 uppercase tracking-wide">State</div>
                        <div id="val_status" class="font-mono text-white font-bold text-sm">READY</div>
                    </div>
                    <div class="glass p-4 rounded text-center border-b-2 border-pi-primary">
                        <div class="text-[10px] text-gray-500 uppercase tracking-wide">Latency</div>
                        <div class="font-mono text-pi-primary font-bold text-lg"><span id="val_lat">--</span>ms</div>
                    </div>
                    <div class="glass p-4 rounded text-center">
                        <div class="text-[10px] text-gray-500 uppercase tracking-wide">TX Count</div>
                        <div class="font-mono text-white font-bold text-lg"><span id="val_curr">0</span>/20</div>
                    </div>
                    <div class="glass p-4 rounded text-center border-b-2 border-pi-success">
                        <div class="text-[10px] text-gray-500 uppercase tracking-wide">Success Rate</div>
                        <div class="font-mono text-pi-success font-bold text-lg"><span id="val_rate">--</span>%</div>
                    </div>
                </div>

                <!-- CHART -->
                <div class="glass p-1 rounded-xl relative flex-grow min-h-[300px] border border-white/5">
                    <div class="absolute top-4 right-5 text-[10px] font-mono text-gray-600 bg-black/50 px-2 rounded">
                        GTW: <span id="proxy_lbl" class="text-gray-400">AUTO</span>
                    </div>
                    <canvas id="mainChart"></canvas>
                </div>

                <!-- CONSOLE -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-56">
                    <div class="md:col-span-2 glass bg-[#050508] p-4 font-mono text-[10px] overflow-y-auto relative custom-scroll rounded-xl border border-white/5" id="console">
                        <div class="scanline"></div>
                        <div class="text-pi-primary mb-1">> System Loaded v8.2</div>
                        <div class="text-gray-500 mb-1">> Payload set to integer "1" (Safe Mode).</div>
                        <div class="text-pi-dim">> Ready for input...</div>
                    </div>

                    <div class="glass p-6 rounded-xl flex flex-col justify-center gap-3">
                        <button id="btn_start" onclick="startTest()" disabled class="w-full bg-gradient-to-r from-gray-700 to-gray-800 text-gray-400 font-bold py-3.5 rounded shadow-lg text-xs uppercase tracking-widest disabled:opacity-50 transition-all">
                            Start Test
                        </button>
                        <button onclick="stopTest()" class="text-[10px] text-red-500 hover:text-white border border-red-900/20 bg-red-900/10 py-2 rounded">Force Stop</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // CONFIG
        const API = "https://api.wallet.fastset.xyz/api/transferToken";
        const PROXIES = [
            (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`, 
            (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`
        ];
        // Standard ID
        const TID = "0xfa575e7000000000000000000000000000000000000000000000000000000000";
        
        let run = false;
        let chart;
        let wallet = { a: '', k: '' };
        let stats = { ok: 0, fail: 0, logs: [] };

        // INIT
        window.onload = () => {
            initChart();
            if(localStorage.getItem('p2_a')) {
                wallet.a = localStorage.getItem('p2_a');
                wallet.k = localStorage.getItem('p2_k');
                toggleUI(true);
            }
        };

        function saveConfig() {
            const a = document.getElementById('inp_addr').value.trim();
            const k = document.getElementById('inp_pk').value.trim();
            if(!a.startsWith('set1') || !k.startsWith('0x')) return alert("Invalid Format! Address must start with 'set1', Key with '0x'");
            localStorage.setItem('p2_a', a); localStorage.setItem('p2_k', k);
            wallet = { a, k };
            toggleUI(true);
            log("Credentials Saved.", 'ok');
        }

        function disconnect() { localStorage.clear(); wallet={a:'',k:''}; toggleUI(false); log("Disconnected.",'warn');}
        
        function toggleUI(connected) {
            const f=document.getElementById('setupForm'), v=document.getElementById('connectedView'), b=document.getElementById('btn_start');
            if(connected) { f.classList.add('hidden'); v.classList.remove('hidden'); b.disabled=false; b.classList.remove('from-gray-700','text-gray-400'); b.classList.add('from-pi-primary','to-cyan-600','text-black'); document.getElementById('display_addr').innerText = wallet.a; }
            else { f.classList.remove('hidden'); v.classList.add('hidden'); b.disabled=true; b.classList.add('from-gray-700'); b.classList.remove('from-pi-primary'); }
        }

        // --- BENCHMARK ---
        async function startTest() {
            if(run) return;
            run = true;
            stats = { ok: 0, fail: 0, logs: [] };
            chart.data.labels = []; chart.data.datasets[0].data = []; chart.update();
            updateStatView(true);

            // FIX: Sending safe "1" integer instead of floats to prevent Error 500
            const PAYLOAD_AMOUNT = "1"; 
            
            const TOTAL = 20;
            let pIdx = 0;

            for(let i=1; i<=TOTAL; i++) {
                if(!run) break;

                const gw = PROXIES[pIdx % PROXIES.length];
                const url = gw(API);
                document.getElementById('proxy_lbl').innerText = (pIdx%2===0) ? 'A' : 'B';

                const start = Date.now();
                log(`Broadcasting '1' Unit (TX #${i})...`, 'dim');

                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            sender: wallet.a, recipient: wallet.a, 
                            amount: PAYLOAD_AMOUNT, 
                            tokenId: TID, privateKey: wallet.k
                        })
                    });

                    // HTTP ERROR HANDLING
                    if(res.status === 500) throw new Error("500: Check Faucet/Balance");
                    if(!res.ok) throw new Error(`HTTP ${res.status}`);

                    // SUCCESS
                    const ms = Date.now() - start;
                    stats.ok++;
                    stats.logs.push({id:i, lat:ms, res:'OK'});
                    
                    log(`‚úÖ Success: ${ms}ms`, 'ok');
                    updateMetrics(ms);
                    explain(ms, null);
                    pushChart(i, ms);

                    await sleep(2500); // 2.5s Delay
                    
                } catch(e) {
                    stats.fail++;
                    stats.logs.push({id:i, lat:0, res:'FAIL'});
                    log(`‚ùå Error: ${e.message}`, 'err');
                    
                    if(e.message.includes('500')) {
                        explain(0, 'Your wallet might be empty. Check Faucet.');
                        run = false; // Stop on fund error
                        break; 
                    } else {
                        // Rotation
                        pIdx++;
                        log("Rotating Proxy...", 'dim');
                        await sleep(3500);
                    }
                }
                
                document.getElementById('val_curr').innerText = i;
            }
            
            stopTest();
        }

        function stopTest() {
            run = false;
            updateStatView(false);
            if(stats.ok > 0) document.getElementById('btn_export').classList.remove('hidden');
            log("Test Sequence Ended.", 'dim');
        }

        // --- HELPERS ---
        function explain(ms, err) {
            const b = document.getElementById('insight_box');
            if(err) { b.innerText = err; b.classList.add('text-pi-danger'); return; }
            b.classList.remove('text-pi-danger');
            
            if(ms < 800) b.innerHTML = "üöÄ <b class='text-pi-primary'>Proof-of-Proof Active.</b> Super fast finality.";
            else if(ms < 2500) b.innerHTML = "‚úÖ <b>Nominal Speed.</b> Transactions are clearing within expected time.";
            else b.innerHTML = "üê¢ <b>Proxy Lag.</b> The slowness is in the HTTP Tunnel, not the Blockchain.";
        }

        function updateMetrics(ms) {
            document.getElementById('val_lat').innerText = ms;
            document.getElementById('val_rate').innerText = ((stats.ok/(stats.ok+stats.fail))*100).toFixed(0) + "%";
            const col = ms < 1000 ? 'text-pi-primary' : ms < 2000 ? 'text-yellow-400' : 'text-pi-danger';
            document.getElementById('val_lat').className = `font-mono font-bold text-lg ${col}`;
        }

        function pushChart(l, d) {
            chart.data.labels.push(l); chart.data.datasets[0].data.push(d);
            if(chart.data.labels.length > 20) { chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
            chart.update();
        }

        function updateStatView(active) {
            document.getElementById('val_status').innerText = active ? "RUNNING" : "FINISHED";
            document.getElementById('val_status').className = active ? "font-mono font-bold text-sm text-pi-primary animate-pulse" : "font-mono font-bold text-sm text-white";
        }
        
        function log(m, t) {
            const el = document.createElement('div');
            el.innerHTML = `<span class="opacity-30 text-[9px] mr-2">${new Date().toLocaleTimeString().split(' ')[0]}</span>${m}`;
            el.className = t==='ok'?"text-pi-success":t==='err'?"text-pi-danger":"text-gray-500";
            const c = document.getElementById('console'); c.prepend(el);
            if(c.children.length>20) c.lastChild.remove();
        }

        function sleep(ms) { return new Promise(r=>setTimeout(r,ms)); }
        
        function downloadCSV() {
            let csv = "ID,Latency,Status\n" + stats.logs.map(r=>`${r.id},${r.lat},${r.res}`).join('\n');
            const b = document.createElement('a'); b.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
            b.download = `sentinel_report_${Date.now()}.csv`; document.body.appendChild(b); b.click(); b.remove();
        }

        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const g = ctx.createLinearGradient(0,0,0,300); g.addColorStop(0,'rgba(0,242,234,0.2)'); g.addColorStop(1,'rgba(0,0,0,0)');
            chart = new Chart(ctx, {type:'line', data:{labels:[], datasets:[{data:[], borderColor:'#00f2ea', backgroundColor:g, fill:true, tension:0.4, borderWidth:2, pointRadius:0}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:false}, scales:{x:{display:false}, y:{grid:{color:'rgba(255,255,255,0.05)'}}}}});
        }
    </script>
</body>
</html>
