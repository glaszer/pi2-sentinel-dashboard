import os
import time
import requests
import json
import random
import pandas as pd
import matplotlib.pyplot as plt
from datetime import datetime
from colorama import init, Fore, Style, Back
from tqdm import tqdm
from tabulate import tabulate

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ü–≤–µ—Ç–æ–≤
init(autoreset=True)

# --- ‚öôÔ∏è –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò ---

VERSION = "6.1 Stable Community"
API_URL = "https://api.wallet.fastset.xyz/api/transferToken"
TOKEN_ID = "0xfa575e7000000000000000000000000000000000000000000000000000000000"
CONFIG_FILE = "sentinel_wallet.json"

# –°–ø–∏—Å–æ–∫ –ø—É–±–ª–∏—á–Ω—ã—Ö –Ω–æ–¥ Ethereum (—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ)
ETH_RPC_LIST = [
    "https://rpc.ankr.com/eth",
    "https://eth.llamarpc.com",
    "https://cloudflare-eth.com",
    "https://1rpc.io/eth",
    "https://rpc.mevblocker.io"
]

HEADERS = {
    "Content-Type": "application/json",
    "User-Agent": f"Mozilla/5.0 Pi2Sentinel/{VERSION}",
    "Origin": "https://wallet.fastset.xyz",
    "Referer": "https://wallet.fastset.xyz/"
}

# --- üß† –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô ---
WIKI = {
    "USL": "Universal Settlement Layer. Pi Squared –Ω–µ –ø—Ä–æ—Å—Ç–æ –±–ª–æ–∫—á–µ–π–Ω, –∞ —Å–ª–æ–π '–Ω–∞–¥' –±–ª–æ–∫—á–µ–π–Ω–∞–º–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Ö –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ (ZK Verify).",
    "FastSet": "–î–≤–∏–∂–æ–∫ –±—ã—Å—Ç—Ä–æ–π —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ (Soft Finality). –û–Ω –¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç (~0.5 —Å–µ–∫), –ø–æ–∫–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Ç—è–∂–µ–ª–æ–µ ZK-–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ.",
    "Burner Wallet": "–ú–µ—Ç–æ–¥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ—à–µ–ª–µ–∫, —á—Ç–æ–±—ã –≤—ã –Ω–µ —Ä–∏—Å–∫–æ–≤–∞–ª–∏ –æ—Å–Ω–æ–≤–Ω—ã–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –∫–ª—é—á–æ–º."
}

# --- üîß –†–ê–ë–û–¢–ê –° –ö–û–®–ï–õ–¨–ö–û–ú ---

def load_or_setup_wallet():
    # –ï—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥ –µ—Å—Ç—å ‚Äî –≥—Ä—É–∑–∏–º
    if os.path.exists(CONFIG_FILE):
        try:
            with open(CONFIG_FILE, "r") as f:
                data = json.load(f)
                if "set1" in data.get("address", ""):
                    return data
        except:
            print(Fore.RED + "‚ö†Ô∏è –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω.")

    # –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –º–∞—Å—Ç–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    print(Fore.CYAN + "=" * 60)
    print("      üîß –ú–ê–°–¢–ï–† –ù–ê–°–¢–†–û–ô–ö–ò (SETUP WIZARD) üîß")
    print(Fore.CYAN + "=" * 60)
    print(" 1. –ó–∞–π–¥–∏ –Ω–∞ https://wallet.fastset.xyz/")
    print(" 2. –°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π –∫–æ—à–µ–ª–µ–∫ (New Wallet).")
    print(" 3. –°–∫–æ–ø–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ —Å—é–¥–∞ (Private Key + Address).")
    print(" ‚ö†Ô∏è  –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Å—Ç–æ–≤—ã–π (–ø—É—Å—Ç–æ–π) –∫–æ—à–µ–ª–µ–∫, –Ω–µ –æ—Å–Ω–æ–≤–Ω–æ–π!")
    print("-" * 60)

    while True:
        pk = input(f"{Fore.GREEN} –í—Å—Ç–∞–≤—å Private Key (0x...): {Fore.WHITE}").strip()
        if not pk.startswith("0x") or len(pk) < 50:
            print(Fore.RED + "‚ùå –û—à–∏–±–∫–∞! –ö–ª—é—á –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è –Ω–∞ '0x'.")
            continue
            
        addr = input(f"{Fore.GREEN} –í—Å—Ç–∞–≤—å Address (set1...): {Fore.WHITE}").strip()
        if not addr.startswith("set1"):
            print(Fore.RED + "‚ùå –û—à–∏–±–∫–∞! –ê–¥—Ä–µ—Å –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è –Ω–∞ 'set1'.")
            continue

        print(Fore.GREEN + "\n‚úÖ –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–Ω—è—Ç—ã!")
        data = {"address": addr, "privateKey": pk}
        with open(CONFIG_FILE, "w") as f:
            json.dump(data, f)
        return data

# --- üåê –î–ê–ù–ù–´–ï –ò–ó ETHEREUM MAINNET ---

def get_eth_data():
    """–ü–æ–ª—É—á–∞–µ—Ç —Ü–µ–Ω—É –≥–∞–∑–∞ –∏ –∫—É—Ä—Å ETH —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–±–æ—Ä RPC"""
    print(f"\n{Fore.CYAN}üì° –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Ethereum Mainnet...", end=" ")
    
    fallback = {
        "gwei": 15.0, "cost_usd": 4.20, "source": "ESTIMATE (Offline)"
    }
    
    for rpc in ETH_RPC_LIST:
        try:
            payload = {"jsonrpc":"2.0","method":"eth_gasPrice","params":[],"id":1}
            resp = requests.post(rpc, json=payload, headers={"Content-Type": "application/json"}, timeout=3)
            data = resp.json()
            
            wei = int(data["result"], 16)
            gwei = wei / 10**9
            
            # –≠–∫–æ–Ω–æ–º–∏–∫–∞: 21000 –≥–∞–∑–∞ * —Ü–µ–Ω–∞ * –∫—É—Ä—Å ($3600 —Ö–∞—Ä–¥–∫–æ–¥)
            eth_price = 3600
            cost_eth = (21000 * wei) / 10**18
            cost_usd = cost_eth * eth_price
            
            print(f"{Fore.GREEN}OK ‚úÖ ({rpc.split('/')[2]})")
            return {"gwei": gwei, "cost_usd": cost_usd, "source": "LIVE MAINNET"}
            
        except:
            continue
            
    print(f"{Fore.RED}FAIL ‚ùå (–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)")
    return fallback

# --- üß™ –Ø–î–†–û –¢–†–ê–ù–ó–ê–ö–¶–ò–ô ---

def send_tx(wallet):
    # –†–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏—è —Å—É–º–º—ã (Anti-Bot Pattern)
    amount = str(random.randint(1, 999))
    
    start = time.time()
    try:
        payload = {
            "sender": wallet["address"],
            "recipient": wallet["address"],
            "amount": amount,
            "tokenId": TOKEN_ID,
            "privateKey": wallet["privateKey"]
        }
        r = requests.post(API_URL, json=payload, headers=HEADERS, timeout=10)
        latency = time.time() - start
        
        return {
            "success": r.status_code == 200,
            "latency": latency,
            "code": r.status_code,
            "amount": amount
        }
    except Exception as e:
        return {"success": False, "latency": 0, "code": "NET", "amount": 0}

# --- üìä –û–¢–†–ò–°–û–í–ö–ê –ì–†–ê–§–ò–ö–û–í ---

def create_charts(df, eth_info):
    if df.empty: return None
    s_df = df[df["status"]=="SUCCESS"]
    if s_df.empty: return None
    
    if not os.path.exists("logs"): os.makedirs("logs")
    ts = int(time.time())
    
    # 1. –ì—Ä–∞—Ñ–∏–∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
    plt.figure(figsize=(10, 5))
    plt.style.use('dark_background')
    plt.plot(s_df["id"], s_df["latency"], color='#00FFFF', marker='o', linestyle='-', linewidth=1, label='FastSet Latency')
    avg_lat = s_df["latency"].mean()
    plt.axhline(y=avg_lat, color='yellow', linestyle='--', label=f'Avg: {avg_lat:.3f}s')
    plt.title('Pi Squared: Network Stability Test')
    plt.ylabel('Seconds')
    plt.legend()
    plt.grid(color='#333333')
    path1 = f"logs/stability_{ts}.png"
    plt.savefig(path1)
    plt.close()
    
    # 2. –ì—Ä–∞—Ñ–∏–∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (Bar Chart)
    networks = ['Pi Squared', 'Solana', 'Ethereum L1']
    vals = [avg_lat, 0.6, 12.05]
    colors = ['#00FFFF', '#A020F0', '#627EEA']
    
    plt.figure(figsize=(8, 6))
    plt.style.use('dark_background')
    bars = plt.bar(networks, vals, color=colors)
    plt.title('Transaction Speed Comparison')
    plt.ylabel('Time (Seconds)')
    
    # –ü–æ–¥–ø–∏—Å–∏
    for bar in bars:
        h = bar.get_height()
        plt.text(bar.get_x() + bar.get_width()/2, h, f'{h:.2f}s', ha='center', va='bottom', color='white', fontweight='bold')
        
    path2 = f"logs/versus_{ts}.png"
    plt.savefig(path2)
    plt.close()
    
    return path1, path2

# --- üïπÔ∏è –†–ï–ñ–ò–ú–´ ---

def mode_benchmark(wallet):
    eth_info = get_eth_data()
    print(f"   Eth Status: {eth_info['gwei']:.1f} Gwei (~${eth_info['cost_usd']:.2f}/tx)")
    
    print(f"\n{Fore.YELLOW}üöÄ Starting FastSet Audit (20 TXs)...")
    history = []
    
    with tqdm(total=20, bar_format="{l_bar}{bar:30}{r_bar}", colour="cyan") as pbar:
        for i in range(1, 21):
            res = send_tx(wallet)
            
            icon = "‚úÖ" if res["success"] else "‚ùå"
            pbar.set_postfix_str(f"{icon} {res['latency']:.3f}s | {res['amount']} wei")
            
            history.append({
                "id": i, "latency": res["latency"], 
                "status": "SUCCESS" if res["success"] else "FAIL"
            })
            pbar.update(1)
            time.sleep(random.uniform(0.3, 0.6))
            
    # –û—Ç—á–µ—Ç
    df = pd.DataFrame(history)
    success_df = df[df["status"]=="SUCCESS"]
    
    if not success_df.empty:
        my_avg = success_df["latency"].mean()
        
        # –¢–∞–±–ª–∏—Ü–∞
        data = [
            [f"{Fore.GREEN}Pi Squared", f"{my_avg:.4f} s", f"{Fore.GREEN}$ 0.00"],
            [f"Ethereum L1", "12.0500 s", f"{Fore.RED}$ {eth_info['cost_usd']:.2f}"]
        ]
        
        print("\n" + Fore.MAGENTA + "üèÜ FINAL BENCHMARK REPORT")
        print(tabulate(data, headers=["Network", "Speed", "Cost"], tablefmt="fancy_grid"))
        
        # –ì—Ä–∞—Ñ–∏–∫–∏
        p1, p2 = create_charts(df, eth_info)
        print(f"\n{Fore.CYAN}üíæ –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω:")
        if p1: print(f"   1. {p1} (–ì—Ä–∞—Ñ–∏–∫ –ø–∏–Ω–≥–∞)")
        if p2: print(f"   2. {p2} (–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å ETH)")
        
        print(f"\n{Fore.YELLOW}üì£ COPY FOR TWITTER:")
        print(f"{Fore.WHITE}Just audited #PiSquared FastSet latency üèéÔ∏èüí®")
        print(f"‚ö° Speed: {my_avg:.3f}s")
        print(f"üí∏ Gas Saved: ${eth_info['cost_usd']*20:.2f} (vs ETH)")
        print("#ZK #ProofOfProof")
        
    else:
        print(Fore.RED + "‚ùå –û—à–∏–±–∫–∞. –ù–µ—Ç —É—Å–ø–µ—à–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å –Ω–∞ 'set1...' –∫–æ—à–µ–ª—å–∫–µ.")

def mode_wiki():
    print(Fore.CYAN + "\nüéì PI SQUARED ACADEMY")
    table = [[k, v] for k, v in WIKI.items()]
    print(tabulate(table, headers=["Term", "Definition"], tablefmt="grid", maxcolwidths=[15, 60]))
    input("\nEnter...")

def mode_sentinel(wallet):
    print(f"\n{Fore.MAGENTA}üõ°Ô∏è Sentinel Monitor (Live Heartbeat)")
    print("–ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞.")
    try:
        count = 1
        while True:
            res = send_tx(wallet)
            ts = datetime.now().strftime("%H:%M:%S")
            if res["success"]:
                print(f"[{ts}] #{count} | {Fore.GREEN}{res['latency']:.3f}s{Fore.WHITE} | {Fore.CYAN}{res['amount']} wei{Fore.WHITE} | ‚úÖ OK")
            else:
                print(f"[{ts}] #{count} | {Fore.RED}ERROR {res['code']}")
            count += 1
            time.sleep(random.uniform(5, 10))
    except KeyboardInterrupt:
        print("Stopped.")

# --- MAIN ---

def main():
    print(Fore.CYAN + Style.BRIGHT + """
   ‚ö° PI SQUARED SENTINEL v6.1 
      Analytics & Stress-Test Tool
    """)
    
    wallet = load_or_setup_wallet()
    print(f"üîë Using Wallet: {Fore.GREEN}{wallet['address']}")
    
    while True:
        print(f"\n{Fore.WHITE} [1] üèé  Run Benchmark (Test + Analytics)")
        print(f" [2] üõ°Ô∏è  Live Monitor (Sentinel)")
        print(f" [3] üéì Academy (Wiki)")
        print(f" [4] ‚ùå Reset Wallet")
        print(f" [0] Exit")
        
        c = input("\n> ")
        
        if c == "1": mode_benchmark(wallet)
        elif c == "2": mode_sentinel(wallet)
        elif c == "3": mode_wiki()
        elif c == "4": 
            if os.path.exists(CONFIG_FILE): os.remove(CONFIG_FILE)
            print("Config deleted."); break
        elif c == "0": break

if __name__ == "__main__":
    main()
