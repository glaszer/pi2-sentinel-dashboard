<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi2 Sentinel | v11.5 Stable</title>
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#050505', panel: '#0f0f12', primary: '#00f0ff',
                        success: '#00ff9d', danger: '#ff2a6d', dim: '#52525b'
                    },
                    fontFamily: { mono: ['"JetBrains Mono"', 'monospace'], display: ['"Space Grotesk"', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050505; color: #e2e8f0; }
        .glass { background: rgba(15, 15, 20, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .scanline { width: 100%; height: 2px; background: rgba(0, 240, 255, 0.5); position: absolute; animation: scan 3s linear infinite; pointer-events: none; opacity: 0.5; }
        @keyframes scan { 0% {top:0;} 100% {top:100%;} }
    </style>
</head>
<body class="font-display min-h-screen flex flex-col relative selection:bg-primary selection:text-black">

    <div class="fixed inset-0 bg-gradient-to-t from-bg via-transparent to-bg/80 z-[-1]"></div>

    <header class="border-b border-white/5 bg-bg/90 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 border border-primary/20 bg-primary/5 flex items-center justify-center font-bold text-primary rounded">π²</div>
                <h1 class="font-bold tracking-widest text-sm">SENTINEL <span class="text-xs text-dim">v11.5 FIX</span></h1>
            </div>
            <button onclick="toggleLang()" id="langBtn" class="text-xs border border-white/10 px-3 py-1 rounded">EN / RU</button>
        </div>
    </header>

    <main class="flex-grow p-4 md:p-6 max-w-7xl mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- CONFIG -->
        <aside class="lg:col-span-3 flex flex-col gap-4">
            <div class="glass p-5 rounded-xl border-t-2 border-primary">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xs font-bold text-dim uppercase">Config</h2>
                    <div id="dot" class="w-2 h-2 rounded-full bg-dim"></div>
                </div>

                <div id="setupView" class="space-y-3">
                    <input type="text" id="inp_addr" class="w-full bg-black/40 border border-white/10 p-2 text-xs font-mono rounded text-white placeholder-dim" placeholder="set1...">
                    <input type="password" id="inp_pk" class="w-full bg-black/40 border border-white/10 p-2 text-xs font-mono rounded text-white placeholder-dim" placeholder="0x...">
                    <button onclick="saveConfig()" class="w-full bg-white/5 hover:bg-primary/20 hover:text-primary text-white text-xs font-bold py-2 rounded transition border border-white/10">
                        CONNECT
                    </button>
                </div>

                <div id="connView" class="hidden text-center py-2">
                    <div class="text-xs text-success font-bold mb-2">CONNECTED</div>
                    <div id="disp_addr" class="font-mono text-[10px] bg-black/40 p-1.5 rounded mb-4 truncate">...</div>
                    <button onclick="disconnect()" class="text-xs text-danger border-b border-danger/30 pb-0.5">Disconnect</button>
                </div>
            </div>
        </aside>

        <!-- CENTER -->
        <section class="lg:col-span-6 flex flex-col gap-4">
            <!-- PIPELINE -->
            <div class="glass h-14 rounded-xl flex items-center justify-between px-6">
                <div class="w-2 h-2 bg-dim rounded-full" id="p1"></div>
                <div class="h-[1px] bg-dim flex-grow mx-2 relative overflow-hidden"><div id="l1" class="absolute h-full w-0 bg-primary transition-all duration-500"></div></div>
                <div class="w-2 h-2 bg-dim rounded-full" id="p2"></div>
                <div class="h-[1px] bg-dim flex-grow mx-2 relative overflow-hidden"><div id="l2" class="absolute h-full w-0 bg-primary transition-all duration-500"></div></div>
                <div class="w-2 h-2 bg-dim rounded-full" id="p3"></div>
                <div class="h-[1px] bg-dim flex-grow mx-2 relative overflow-hidden"><div id="l3" class="absolute h-full w-0 bg-success transition-all duration-500"></div></div>
                <div class="w-3 h-3 border border-dim rounded-full flex items-center justify-center" id="p4">
                     <i id="check" class="fas fa-check text-[8px] text-transparent"></i>
                </div>
            </div>

            <!-- CHART -->
            <div class="glass p-1 rounded-xl flex-grow min-h-[300px] relative">
                <div class="absolute top-3 left-4 pointer-events-none">
                     <div class="text-2xl font-mono font-bold text-white"><span id="val_avg">0</span> <span class="text-sm text-primary">ms</span></div>
                </div>
                <div class="mt-8 relative h-[250px]"><canvas id="mainChart"></canvas></div>
            </div>

            <!-- ACTIONS -->
            <div class="grid grid-cols-2 gap-4 h-32">
                <div class="glass p-3 font-mono text-[9px] overflow-y-auto relative bg-black/40" id="console">
                    <div class="text-primary">> System Ready. Connect Wallet first.</div>
                </div>
                <div class="flex flex-col gap-2">
                    <button id="btn_start" onclick="runSequence()" disabled class="h-full bg-white/5 border border-white/10 text-dim font-bold uppercase tracking-widest text-xs rounded transition hover:bg-primary/20 hover:text-primary disabled:opacity-30 disabled:hover:bg-transparent">
                        START TEST
                    </button>
                    <button onclick="abort()" class="h-8 border border-danger/30 text-danger hover:bg-danger/10 text-[9px] rounded">STOP</button>
                </div>
            </div>
        </section>

        <!-- RIGHT -->
        <aside class="lg:col-span-3 h-full">
            <div class="glass h-full rounded-xl p-6 relative flex flex-col border-t-2 border-accent">
                <h3 class="text-xs font-bold text-accent uppercase mb-4">Info Feed</h3>
                <div id="info_card" class="flex-grow flex items-center justify-center">
                    <div class="text-center w-full transition-opacity duration-500 opacity-100" id="info_inner">
                        <div class="text-sm font-bold text-white mb-2" id="info_t">Welcome</div>
                        <div class="text-[10px] text-gray-400 font-mono" id="info_d">Connect wallet to begin diagnostics.</div>
                    </div>
                </div>
                <button onclick="downloadCSV()" id="btn_exp" class="hidden mt-auto w-full bg-white/10 text-white text-[10px] py-2 rounded uppercase font-bold">Download CSV</button>
            </div>
        </aside>

    </main>

    <script>
        // GLOBAL APP VARIABLE (NO 'state' vs 'app' confusion anymore)
        let app = {
            run: false,
            lang: 'en',
            logs: [],
            ok: 0,
            wallet: {},
            timer: null
        };

        const ENDPOINT = "https://api.wallet.fastset.xyz/api/transferToken";
        const PROXIES = [
            (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`,
            (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`
        ];
        const TID = "0xfa575e7000000000000000000000000000000000000000000000000000000000";

        const DATA = {
            en: [
                {t: "Proof-of-Proof", d: "Pi Squared verifies validity proofs instead of re-executing transactions. This enables massive scaling."},
                {t: "FastSet Consensus", d: "FastSet achieves sub-second finality by separating dissemination from execution."},
                {t: "Universal Settlement", d: "A trustless settlement layer (USL) for any blockchain via ZK-proofs."},
                {t: "K-Framework", d: "Formally verified semantics ensure code behaves exactly as specified mathematically."}
            ],
            ru: [
                {t: "Proof-of-Proof", d: "Pi Squared проверяет доказательства вместо повторного выполнения. Это дает масштабируемость."},
                {t: "FastSet Консенсус", d: "Мгновенная финализация (менее 1с) благодаря разделению исполнения и консенсуса."},
                {t: "Universal Settlement", d: "Универсальный слой расчетов (USL) для любых блокчейнов через ZK."},
                {t: "K-Framework", d: "Формально верифицированная семантика гарантирует математическую точность кода."}
            ]
        };

        let chart;

        // INIT
        window.onload = () => {
            initChart();
            if(localStorage.getItem('ps_a')) {
                app.wallet.a = localStorage.getItem('ps_a');
                app.wallet.k = localStorage.getItem('ps_k');
                uiConn(true);
            }
        };

        // SETUP FUNCTIONS
        function saveConfig() {
            const a = document.getElementById('inp_addr').value.trim();
            const k = document.getElementById('inp_pk').value.trim();
            if(!a || !k) return alert("Empty fields!");
            localStorage.setItem('ps_a', a); localStorage.setItem('ps_k', k);
            app.wallet = {a,k}; uiConn(true);
            log("Credentials Saved.", 'ok');
        }

        function disconnect() {
            localStorage.clear(); app.wallet={}; uiConn(false);
            log("Disconnected.", 'norm');
        }

        function uiConn(active) {
            const f = document.getElementById('setupView');
            const c = document.getElementById('connectedView');
            const btn = document.getElementById('btn_start'); // КНОПКА ЗДЕСЬ
            const dot = document.getElementById('dot');

            if(active) {
                f.classList.add('hidden'); c.classList.remove('hidden'); 
                btn.disabled = false; // РАЗБЛОКИРОВКА КНОПКИ
                btn.classList.remove('text-dim','bg-white/5'); 
                btn.classList.add('text-primary','bg-primary/20','pulse-border'); // Make it green/cyan
                
                document.getElementById('disp_addr').innerText = app.wallet.a;
                dot.className = "w-2 h-2 rounded-full bg-success shadow-[0_0_5px_lime]";
            } else {
                f.classList.remove('hidden'); c.classList.add('hidden'); 
                btn.disabled = true; // БЛОКИРОВКА
                btn.classList.add('text-dim','bg-white/5');
                btn.classList.remove('text-primary','bg-primary/20','pulse-border');
                
                dot.className = "w-2 h-2 rounded-full bg-dim";
            }
        }

        function toggleLang() {
            app.lang = app.lang==='en'?'ru':'en';
            document.getElementById('langBtn').innerText = app.lang==='en'?"EN / RU":"RU / EN";
            updateCard(0);
        }

        // MAIN LOOP
        async function runSequence() {
            if(app.run) return;
            app.run = true; app.ok=0; app.logs=[];
            resetChart();
            document.getElementById('btn_exp').classList.add('hidden');
            const btn = document.getElementById('btn_start');
            btn.innerText = "RUNNING...";

            startRotation(); // Start Info Feed

            for(let i=1; i<=20; i++) {
                if(!app.run) break;

                const idx = i % 2; 
                setLine(1);
                const url = PROXIES[idx](ENDPOINT);
                log(`TX #${i}: Broadcasting...`, 'norm');
                
                const start = Date.now();
                setLine(2);

                try {
                    const r = await fetch(url, {
                        method: 'POST', headers:{'Content-Type':'application/json'},
                        body: JSON.stringify({ sender:app.wallet.a, recipient:app.wallet.a, amount:"1", tokenId:TID, privateKey:app.wallet.k })
                    });
                    
                    if(!r.ok && r.status !== 200) throw new Error("HTTP Err");

                    setLine(3); 
                    const ms = Date.now() - start;
                    app.ok++;
                    app.logs.push({id:i, lat:ms});

                    // UI Updates
                    log(`> Success: ${ms}ms`, 'ok');
                    updateChart(i, ms);
                    document.getElementById('val_avg').innerText = (app.logs.reduce((a,b)=>a+b.lat,0)/app.logs.length).toFixed(0);

                    // Final Animation
                    setLine(4);
                    await sleep(2000); 
                    setLine(0);

                } catch(e) {
                    log(`> Retrying (Proxy rotation)...`, 'err');
                    await sleep(3000);
                }
            }
            abort();
        }

        function abort() {
            app.run = false;
            stopRotation();
            document.getElementById('btn_start').innerText = "START TEST";
            setLine(0);
            if(app.ok>0) document.getElementById('btn_exp').classList.remove('hidden');
            log("Done.", 'norm');
        }

        // INFO ROTATION
        function startRotation() {
            let i = 0; updateCard(0);
            app.timer = setInterval(() => { i++; updateCard(i); }, 6000);
        }
        function stopRotation() { clearInterval(app.timer); }
        
        function updateCard(i) {
            const list = DATA[app.lang];
            const item = list[i % list.length];
            const div = document.getElementById('info_inner');
            div.classList.add('opacity-0');
            setTimeout(() => {
                document.getElementById('info_t').innerText = item.t;
                document.getElementById('info_d').innerText = item.d;
                div.classList.remove('opacity-0');
            }, 500);
        }

        // HELPERS
        function setLine(s) {
            const col = "bg-primary shadow-[0_0_8px_cyan]";
            if(s>=1) document.getElementById('p1').className=`w-2 h-2 rounded-full ${col}`;
            if(s>=2) { document.getElementById('p2').className=`w-2 h-2 rounded-full ${col}`; document.getElementById('l1').style.width="100%"; }
            if(s>=3) { document.getElementById('p3').className=`w-2 h-2 rounded-full ${col}`; document.getElementById('l2').style.width="100%"; }
            if(s>=4) { 
                document.getElementById('p4').className="w-3 h-3 border border-success bg-success rounded-full flex items-center justify-center shadow-[0_0_10px_lime]"; 
                document.getElementById('l3').style.width="100%";
                document.getElementById('check').className="fas fa-check text-[7px] text-black";
            }
            if(s===0) {
                ['p1','p2','p3'].forEach(i=>document.getElementById(i).className="w-2 h-2 bg-dim rounded-full");
                ['l1','l2','l3'].forEach(i=>document.getElementById(i).style.width="0%");
                document.getElementById('p4').className="w-3 h-3 border border-dim rounded-full flex items-center justify-center";
                document.getElementById('check').className="fas fa-check text-transparent";
            }
        }

        function log(m, t) {
            const d = document.createElement('div');
            d.innerHTML = `> ${m}`;
            d.className = t==='ok'?"text-success":t==='err'?"text-danger":"text-dim";
            const c = document.getElementById('console'); c.prepend(d);
            if(c.children.length>20) c.lastChild.remove();
        }

        function updateChart(l, d) {
            chart.data.labels.push(l); chart.data.datasets[0].data.push(d);
            if(chart.data.labels.length>20) {chart.data.labels.shift(); chart.data.datasets[0].data.shift();}
            chart.update();
        }
        function resetChart() { chart.data.labels=[]; chart.data.datasets[0].data=[]; chart.update(); document.getElementById('val_avg').innerText="0"; }
        function sleep(ms) { return new Promise(r=>setTimeout(r,ms)); }
        function downloadCSV() {
            let c="ID,Lat\n"+app.logs.map(x=>`${x.id},${x.lat}`).join('\n');
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([c],{type:'text/csv'}));
            a.download="report.csv"; document.body.appendChild(a); a.click(); a.remove();
        }

        function initChart() {
            const ctx=document.getElementById('mainChart').getContext('2d');
            const g=ctx.createLinearGradient(0,0,0,300); g.addColorStop(0,'rgba(0,240,255,0.2)'); g.addColorStop(1,'rgba(0,0,0,0)');
            chart = new Chart(ctx, {
                type: 'line',
                data: {labels:[], datasets:[{data:[], borderColor:'#00f0ff', borderWidth:2, backgroundColor:g, fill:true, tension:0.4, pointRadius:0}]},
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:false}, scales:{x:{display:false}, y:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#555'}}} }
            });
        }
    </script>
</body>
</html>
